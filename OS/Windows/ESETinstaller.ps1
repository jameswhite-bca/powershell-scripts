#Author: Ryan Baldry
#Version 0.2
#Comments: In Testing NOT for general use, 
#used Resolve-Path so the script doesn't break everytime the URL is updated with new versions


#grabbing the ESET installer
Write-Progress -Activity "Downloading ESET Zip file" -PercentComplete 0

$url = "http://doris.piiplat.com/eset/ESET7pack.zip" #url variable
$output ="C:\Pulsant\ESET7.zip" #location to put the .zip folder
(New-Object System.Net.WebClient).DownloadFile($url, $output) #getting .zip and putting it into the locaiton

#unzipping ESET installer
Write-Progress -Activity "Extracting ESET Zip file" -PercentComplete 25 #percent bar
Expand-Archive -LiteralPath "C:\Pulsant\ESET7.zip" -DestinationPath "C:\Pulsant\ESET7pack" #actually unzipping folder

#Installing file Security
Write-Progress -Activity "Install ESET File Secuirty" -PercentComplete 50 
$efsw_path = Resolve-Path "C:\Pulsant\ESET7pack\efsw*.msi" | select -ExpandProperty Path 
start-Process -FilePath $efsw_path -ArgumentList '/passive' -Wait #process to install 

#Installing Management Agent
Write-Progress -Activity "Install ESET Agent" -PercentComplete 75

#taking certs exported as base64 and putting into file in the eset7 folders
$CA_Cert="MIID3zCCAsegAwIBAgIQNOARc+leXIlNI/OWxiKHpjANBgkqhkiG9w0BAQUFADCBhzEsMCoGA1UEAxMjRVNFVCBTZXJ2ZXIgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkxDTALBgNVBAsTBFBFSVAxEDAOBgNVBAoTB1B1bHNhbnQxEDAOBgNVBAcTB1JlYWRpbmcxFzAVBgNVBAgTDlVuaXRlZCBLaW5nZG9tMQswCQYDVQQGEwJHQjAeFw0xODAyMTIwMDAwMDBaFw0yODAyMTQwMDAwMDBaMIGHMSwwKgYDVQQDEyNFU0VUIFNlcnZlciBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTENMAsGA1UECxMEUEVJUDEQMA4GA1UEChMHUHVsc2FudDEQMA4GA1UEBxMHUmVhZGluZzEXMBUGA1UECBMOVW5pdGVkIEtpbmdkb20xCzAJBgNVBAYTAkdCMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAslwJd0j2c2o1PgSrl5x5s2LlPnKd/5CbmsAei3oasjckuXHn+8+sBxiEoACuZlt/FZnJvqYUuvOs7Lp59RpAlHwXxJZP+mb27J0AIXAtFdZQgXBACyUUeEKH7mOK0OvfJHmXSGy1R6MUZk9rwbJbFjZMe1/o2dHa8vLkeotvWDvxacYurR7kbzg6F0YbIy2of3Bt7lSOVermXgXxlXf6x7U6AKBPC8/qflVoeLtwlkPjHfqbIwb/iUQuuY28WlhpY+68mtZcCFxCCEdXOP67mK86PkXgGIHr7ZAzZJYmYS3hzbYTLGew65CQ2QcBAUVa7IQ/lwJXYQEy/cK9O+I40wIDAQABo0UwQzAOBgNVHQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBADAdBgNVHQ4EFgQUB+8URcXklA7NkiIJOQpnDQaxNEQwDQYJKoZIhvcNAQEFBQADggEBAHbRGm3A6Dcz+u4e3/g8q/8z0rpKHuZQjBZh7qzv99/YUJiRn/MV81o4K0FrllQ38Z/ES2qZF13DYnXzC1iw/FYPRVHp3pNrHKmZP82N8rYRw73qGQDVPTg6bOT+MyGYPL39zyMYqLQKnIP0DqMDzCcp4ghoaGiHU7slrn77EMrvoZLTgDRp9ZpDfMguHehZ3BF7MUG7hRSsUUFw9hWQNaEJ4lXlK0QLtFo3c9XeycFpFFPi7XiZeRcdaA38COj24/cdjesEU7Nun3J2OXjiD3L71XdiuGPvhvbyEDX3aBmVVGvQr7wno/VeZbK3OJWX4Ss/0DNYrngqujqh1b/cWHY="
$CA_Cert | Set-Content "C:\Pulsant\ESET7pack\Certification Authority CN=ESET.txt"

$Agent_Cert="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"
$Agent_Cert | Set-Content "C:\Pulsant\ESET7pack\Certificate Export CN=Agent.txt"

$agent_path = Resolve-Path "C:\Pulsant\ESET7pack\agent*.msi"| select -ExpandProperty Path 

$AgentArguments = @(
    '/L*V "C:\Pulsant\log.log"'
    'P_HOSTNAME="rdg3peipavsrv01.sec.peiplat.net"'
    'P_PORT=2222'
    'P_ENABLE_TELEMETRY=0'
    'P_CERT_PATH="C:\Pulsant\ESET7pack\Certificate Export CN=Agent.txt"'
    'P_CERT_AUTH_PATH="C:\Pulsant\ESET7pack\Certification Authority CN=ESET.txt"'
    'P_LOAD_CERTS_FROM_FILE_AS_BASE64=YES'
    'P_USE_PROXY=1'
    'P_PROXY_HTTP_HOSTNAME="hoba.peiplat.com"'
    'P_PROXY_HTTP_PORT=3128'
    '/passive'
)

Start-Process -FilePath $agent_path -ArgumentList $AgentArguments -Wait